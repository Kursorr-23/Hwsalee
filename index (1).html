<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hot Wheels Market</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å) */
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #40a7e3;
            --tg-theme-button-text-color: #ffffff;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --border-radius: 16px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --tg-theme-bg-color: #1f1f1f;
                --tg-theme-text-color: #ffffff;
                --tg-theme-hint-color: #aaaaaa;
                --tg-theme-link-color: #6ab3f3;
                --tg-theme-button-color: #6ab3f3;
                --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            line-height: 1.5;
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px 16px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }

        header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .add-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
            box-shadow: var(--card-shadow);
        }

        .add-button:hover {
            opacity: 0.9;
        }

        /* –§–æ—Ä–º–∞ */
        .form-popup {
            background-color: var(--tg-theme-bg-color);
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
        }

        .form-popup h2 {
            margin-bottom: 20px;
            font-size: 20px;
        }

        #product-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #product-form label {
            font-weight: 500;
            margin-bottom: -8px;
            font-size: 14px;
        }

        #product-form input,
        #product-form textarea,
        #product-form input[type="file"] {
            padding: 12px 16px;
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 12px;
            font-size: 16px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            outline: none;
            transition: border-color 0.2s;
            width: 100%;
        }

        #product-form input[type="file"] {
            padding: 10px;
            cursor: pointer;
        }

        #product-form input[type="file"]::-webkit-file-upload-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
        }

        #product-form input:focus,
        #product-form textarea:focus {
            border-color: var(--tg-theme-button-color);
        }

        #product-form textarea {
            resize: vertical;
            min-height: 80px;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 12px;
            border: 1px solid var(--tg-theme-hint-color);
            margin-top: 5px;
        }

        .input-hint {
            font-size: 12px;
            color: var(--tg-theme-hint-color);
            margin-top: -10px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }

        .form-actions button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        #save-product-btn {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        #cancel-form-btn {
            background-color: transparent;
            border: 1px solid var(--tg-theme-hint-color);
            color: var(--tg-theme-text-color);
        }

        /* –°–µ—Ç–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 16px;
        }

        .loading {
            grid-column: 1 / -1;
            text-align: center;
            color: var(--tg-theme-hint-color);
            padding: 40px;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ */
        .product-card {
            background-color: var(--tg-theme-bg-color);
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: transform 0.2s;
        }

        .product-card:hover {
            transform: translateY(-4px);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
            background-color: var(--tg-theme-hint-color);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .product-header h3 {
            font-size: 20px;
            font-weight: 600;
            word-break: break-word;
        }

        .price {
            font-size: 22px;
            font-weight: 700;
            color: var(--tg-theme-button-color);
            white-space: nowrap;
        }

        .description {
            color: var(--tg-theme-hint-color);
            font-size: 14px;
            line-height: 1.5;
            word-break: break-word;
        }

        .seller-info {
            margin: 8px 0;
            font-size: 14px;
            background-color: rgba(128, 128, 128, 0.1);
            padding: 8px 12px;
            border-radius: 30px;
            display: inline-block;
            align-self: flex-start;
        }

        .seller-info a {
            color: var(--tg-theme-link-color);
            text-decoration: none;
            font-weight: 500;
        }

        .product-actions {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .edit-btn, .delete-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .edit-btn {
            background-color: var(--tg-theme-hint-color);
            color: var(--tg-theme-bg-color);
        }

        .delete-btn {
            background-color: #ff3b30;
            color: white;
        }

        .delete-btn:hover, .edit-btn:hover {
            opacity: 0.8;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 480px) {
            header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .add-button {
                width: 100%;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .product-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>üèéÔ∏è Hot Wheels Market</h1>
            <button class="add-button" id="show-add-form-btn">+ –ü—Ä–æ–¥–∞—Ç—å –º–∞—à–∏–Ω–∫—É</button>
        </header>

        <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞) -->
        <div class="form-popup" id="product-form-container" style="display: none;">
            <form id="product-form">
                <h2 id="form-title">–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
                
                <label for="car-image">–§–æ—Ç–æ –º–∞—à–∏–Ω–∫–∏ *</label>
                <input type="file" id="car-image" accept="image/*" required>
                <img id="image-preview" class="image-preview" style="display: none;" alt="–ü—Ä–µ–≤—å—é">
                
                <label for="car-name">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—à–∏–Ω–∫–∏ *</label>
                <input type="text" id="car-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '67 Camaro" required maxlength="100">
                
                <label for="car-price">–¶–µ–Ω–∞ (–¥–æ 1,000,000 ‚ÇΩ) *</label>
                <input type="number" id="car-price" placeholder="999" min="1" max="1000000" required>
                
                <label for="car-description">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
                <textarea id="car-description" placeholder="–°–æ—Å—Ç–æ—è–Ω–∏–µ, –≥–æ–¥, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏..." rows="3" required maxlength="500"></textarea>
                
                <label for="user-tag">–í–∞—à Telegram (–¥–ª—è —Å–≤—è–∑–∏) *</label>
                <div class="input-hint">–ù–∞–ø—Ä–∏–º–µ—Ä: @username –∏–ª–∏ —Å—Å—ã–ª–∫–∞</div>
                <input type="text" id="user-tag" placeholder="@your_username" required>

                <!-- üîê –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è –∫–æ–¥–∞ –¥–æ—Å—Ç—É–ø–∞ -->
                <label for="access-code">–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞ *</label>
                <div class="input-hint">–í–≤–µ–¥–∏—Ç–µ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∫–æ–¥ 34578348583</div>
                <input type="password" id="access-code" placeholder="****" required maxlength="20">
                
                <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –∏ —Ñ–æ—Ç–æ -->
                <input type="hidden" id="product-id" value="">
                <input type="hidden" id="product-image-data" value="">
                
                <div class="form-actions">
                    <button type="submit" id="save-product-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" id="cancel-form-btn">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç: –ª–µ–Ω—Ç–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π -->
        <main>
            <h2>–û–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
            <div id="products-list" class="products-grid">
                <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ -->
                <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π...</p>
            </div>
        </main>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- –ö–ª—é—á –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ localStorage ---
        const STORAGE_KEY = 'hotwheels_market_ads';

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        let currentUser = null;
        let products = [];

        // --- –≠–ª–µ–º–µ–Ω—Ç—ã DOM ---
        const productsListEl = document.getElementById('products-list');
        const formContainer = document.getElementById('product-form-container');
        const productForm = document.getElementById('product-form');
        const showAddFormBtn = document.getElementById('show-add-form-btn');
        const cancelFormBtn = document.getElementById('cancel-form-btn');
        const formTitle = document.getElementById('form-title');
        const productIdInput = document.getElementById('product-id');
        const productImageDataInput = document.getElementById('product-image-data');
        const carImageInput = document.getElementById('car-image');
        const imagePreview = document.getElementById('image-preview');
        const carNameInput = document.getElementById('car-name');
        const carPriceInput = document.getElementById('car-price');
        const carDescriptionInput = document.getElementById('car-description');
        const userTagInput = document.getElementById('user-tag');
        const accessCodeInput = document.getElementById('access-code'); // –Ω–æ–≤–æ–µ –ø–æ–ª–µ

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram (–µ—Å–ª–∏ –æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)
        function getCurrentUser() {
            if (tg.initDataUnsafe?.user) {
                const user = tg.initDataUnsafe.user;
                let username = user.username ? `@${user.username}` : `${user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}`;
                return {
                    id: user.id,
                    username: username,
                    firstName: user.first_name,
                };
            } else {
                // –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –≤–Ω–µ Telegram
                return {
                    id: 'test_user_' + Date.now(),
                    username: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                    firstName: '–¢–µ—Å—Ç',
                };
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∏–∑ localStorage
        function loadProducts() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    products = JSON.parse(stored);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
                    products = [];
                }
            } else {
                // –ù–∞—á–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø—É—Å—Ç–æ–µ
                products = [
                    {
                        id: '1',
                        name: 'Hot Wheels \'67 Camaro',
                        price: 1500,
                        description: '–†–µ–¥–∫–∞—è –º–æ–¥–µ–ª—å, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–ª–∏—á–Ω–æ–µ, –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞.',
                        seller: '@camaro_fan',
                        sellerId: 'test_seller_1',
                        date: new Date().toISOString(),
                        imageData: 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\' viewBox=\'0 0 200 200\'%3E%3Crect width=\'200\' height=\'200\' fill=\'%2340a7e3\'/%3E%3Ctext x=\'50\' y=\'115\' font-size=\'20\' fill=\'white\'%3E67 Camaro%3C/text%3E%3C/svg%3E'
                    },
                    {
                        id: '2',
                        name: 'Porsche 911 GT3',
                        price: 3200,
                        description: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å, –ª–∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–ø—É—Å–∫.',
                        seller: '@porsche_collector',
                        sellerId: 'test_seller_2',
                        date: new Date().toISOString(),
                        imageData: 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\' viewBox=\'0 0 200 200\'%3E%3Crect width=\'200\' height=\'200\' fill=\'%23ff3b30\'/%3E%3Ctext x=\'40\' y=\'115\' font-size=\'20\' fill=\'white\'%3EPorsche 911%3C/text%3E%3C/svg%3E'
                    }
                ];
                saveProducts();
            }
            renderProducts();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ localStorage
        function saveProducts() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        function resetForm() {
            productForm.reset();
            productIdInput.value = '';
            productImageDataInput.value = '';
            imagePreview.style.display = 'none';
            imagePreview.src = '';
            formTitle.textContent = '–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ';
            formContainer.style.display = 'none';
            accessCodeInput.value = ''; // –æ—á–∏—â–∞–µ–º –∫–æ–¥
        }

        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –≤ Data URL
        function fileToDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // --- –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        function renderProducts() {
            if (products.length === 0) {
                productsListEl.innerHTML = '<p class="loading">–ü–æ–∫–∞ –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>';
                return;
            }

            const sorted = [...products].sort((a, b) => new Date(b.date) - new Date(a.date));

            productsListEl.innerHTML = sorted.map(product => {
                const isOwner = currentUser && (product.sellerId === currentUser.id);
                const formattedPrice = new Intl.NumberFormat('ru-RU').format(product.price) + ' ‚ÇΩ';

                return `
                    <div class="product-card" data-product-id="${product.id}">
                        <img class="product-image" src="${escapeHtml(product.imageData)}" alt="${escapeHtml(product.name)}">
                        <div class="product-header">
                            <h3>${escapeHtml(product.name)}</h3>
                            <span class="price">${formattedPrice}</span>
                        </div>
                        <p class="description">${escapeHtml(product.description)}</p>
                        <div class="seller-info">
                            –ü—Ä–æ–¥–∞–≤–µ—Ü: <a href="https://t.me/${escapeHtml(product.seller.replace('@', ''))}" target="_blank">${escapeHtml(product.seller)}</a>
                        </div>
                        ${isOwner ? `
                            <div class="product-actions">
                                <button class="edit-btn" onclick="editProduct('${product.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                <button class="delete-btn" onclick="deleteProduct('${product.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function addProduct(productData) {
            const newProduct = {
                id: Date.now().toString(),
                ...productData,
                sellerId: currentUser.id,
                date: new Date().toISOString()
            };
            products.push(newProduct);
            saveProducts();
            renderProducts();
        }

        function updateProduct(id, updatedData) {
            const index = products.findIndex(p => p.id === id);
            if (index !== -1) {
                products[index] = {
                    ...products[index],
                    ...updatedData,
                    sellerId: products[index].sellerId,
                    date: products[index].date
                };
                saveProducts();
                renderProducts();
            }
        }

        window.deleteProduct = function(id) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')) {
                products = products.filter(p => p.id !== id);
                saveProducts();
                renderProducts();
                if (productIdInput.value === id) {
                    resetForm();
                }
                tg.HapticFeedback.impactOccurred('light');
            }
        };

        window.editProduct = function(id) {
            const product = products.find(p => p.id === id);
            if (product && product.sellerId === currentUser.id) {
                carNameInput.value = product.name;
                carPriceInput.value = product.price;
                carDescriptionInput.value = product.description;
                userTagInput.value = product.seller;
                productIdInput.value = product.id;
                productImageDataInput.value = product.imageData;
                
                if (product.imageData) {
                    imagePreview.src = product.imageData;
                    imagePreview.style.display = 'block';
                }
                
                formTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ';
                formContainer.style.display = 'block';
                formContainer.scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ');
            }
        };

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---

        carImageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const dataURL = await fileToDataURL(file);
                    imagePreview.src = dataURL;
                    imagePreview.style.display = 'block';
                    productImageDataInput.value = dataURL;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                }
            }
        });

        showAddFormBtn.addEventListener('click', () => {
            resetForm();
            formContainer.style.display = 'block';
            formContainer.scrollIntoView({ behavior: 'smooth' });
        });

        cancelFormBtn.addEventListener('click', resetForm);

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –¥–æ—Å—Ç—É–ø–∞
            const CORRECT_CODE = '34578348583';
            if (accessCodeInput.value.trim() !== CORRECT_CODE) {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞. –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ.');
                return;
            }

            const price = parseInt(carPriceInput.value, 10);
            if (price > 1000000) {
                alert('–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 1,000,000 ‚ÇΩ');
                return;
            }

            let imageData = productImageDataInput.value;
            
            if (carImageInput.files.length > 0) {
                try {
                    imageData = await fileToDataURL(carImageInput.files[0]);
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    return;
                }
            } else if (!imageData) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –º–∞—à–∏–Ω–∫–∏');
                return;
            }

            const productData = {
                name: carNameInput.value.trim(),
                price: price,
                description: carDescriptionInput.value.trim(),
                seller: userTagInput.value.trim(),
                imageData: imageData
            };

            if (!productData.name || !productData.price || !productData.description || !productData.seller) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            const productId = productIdInput.value;

            if (productId) {
                updateProduct(productId, productData);
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                addProduct(productData);
                tg.HapticFeedback.notificationOccurred('success');
            }

            resetForm();
        });

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
        function initApp() {
            currentUser = getCurrentUser();
            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', currentUser);
            
            if (currentUser.username && userTagInput) {
                userTagInput.value = currentUser.username;
            }

            loadProducts();

            tg.MainButton.setText('–ó–∞–∫—Ä—ã—Ç—å');
            tg.onEvent('mainButtonClicked', function() {
                tg.close();
            });
            tg.MainButton.show();
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
